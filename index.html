<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEDES LA PAZ - SUISD | Registro Rápido</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Outfit:wght@500;700;800&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">

    <style>
        /* --- VARIABLES DE TEMA DINÁMICO --- */
        :root {
            /* Tema CLARO */
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border-color: #cbd5e1;
            --input-bg: #ffffff;
            --header-grad-1: #7f1d1d;
            --header-grad-2: #991b1b;
            --accent-color: #991b1b;
            --shadow-color: rgba(0, 0, 0, 0.05);
        }

        [data-theme="dark"] {
            /* Tema OSCURO */
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --border-color: #334155;
            --input-bg: #0f172a;
            --header-grad-1: #450a0a;
            --header-grad-2: #7f1d1d;
            --accent-color: #ef4444;
            --shadow-color: rgba(0, 0, 0, 0.3);
        }

        /* ESTILOS BASE */
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-main); transition: background 0.3s, color 0.3s; }
        h1, h2, h3, .font-display { font-family: 'Outfit', sans-serif; }
        
        /* HEADER */
        .header-bg { 
            background: linear-gradient(135deg, var(--header-grad-1), var(--header-grad-2));
            box-shadow: 0 4px 20px -5px rgba(0,0,0,0.3);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        /* TARJETAS */
        .card-dynamic {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px var(--shadow-color);
            transition: all 0.3s ease;
        }

        /* INPUTS */
        .input-group { position: relative; margin-bottom: 1.25rem; }
        .input-field { 
            display: block; width: 100%; padding: 12px 16px; font-size: 0.95rem; 
            background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 0.75rem; 
            transition: all 0.2s; font-weight: 600; color: var(--text-main);
            text-transform: uppercase; 
        }
        .input-field:focus { 
            border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(153, 27, 27, 0.15); 
            outline: none;
        }
        .input-label { 
            position: absolute; top: 12px; left: 14px; color: var(--text-muted); 
            background: var(--input-bg); padding: 0 6px; transition: all 0.2s; 
            pointer-events: none; font-size: 0.9rem; font-weight: 500; border-radius: 4px;
        }
        .input-field:focus ~ .input-label, 
        .input-field:not(:placeholder-shown) ~ .input-label { 
            top: -9px; left: 12px; font-size: 0.75rem; color: var(--accent-color); 
            font-weight: 800; 
        }

        /* ÁREA DE FIRMA */
        .signature-wrapper {
            background-color: #ffffff;
            border: 2px dashed var(--border-color); border-radius: 1rem;
            position: relative; height: 180px; overflow: hidden; cursor: crosshair;
        }
        canvas { width: 100%; height: 100%; display: block; }

        /* BOTONES */
        .btn-theme-toggle {
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
            color: white; width: 36px; height: 36px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            transition: all 0.3s;
        }
        .btn-theme-toggle:hover { background: rgba(255,255,255,0.2); transform: rotate(15deg); }

        .btn-search { 
            background: var(--bg-body); color: var(--text-muted); border-radius: 0 0.75rem 0.75rem 0;
            padding: 0 24px; border: 1px solid var(--border-color); border-left: none;
            transition: all 0.2s; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .btn-search:hover { background: var(--border-color); color: var(--accent-color); }

        .btn-action {
            background: linear-gradient(to right, #991b1b, #b91c1c); color: white; 
            font-weight: 800; text-transform: uppercase; letter-spacing: 1.5px; font-size: 1rem;
            padding: 16px; border-radius: 1rem; box-shadow: 0 10px 20px -5px rgba(185, 28, 28, 0.4);
            transition: all 0.3s; width: 100%; border: none;
        }
        .btn-action:hover { transform: translateY(-2px); filter: brightness(1.1); }

        /* CONFIRMACIÓN MODAL ESTILOS */
        .swal-container-custom { text-align: left; font-family: 'Inter', sans-serif; color: #334155; }
        .conf-box { background: #f8fafc; padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 5px; }
        .conf-title { font-size: 0.7rem; font-weight: 800; color: #64748b; text-transform: uppercase; border-bottom: 1px solid #e2e8f0; padding-bottom: 2px; margin-bottom: 4px; }
        .conf-row { display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 2px; }
        .conf-val { font-weight: 700; color: #0f172a; text-transform: uppercase; }
        .conf-code { font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; background: #fff; padding: 4px; border: 1px solid #cbd5e1; border-radius: 4px; word-break: break-all; }

        .disabled-section { opacity: 0.5; pointer-events: none; filter: grayscale(1); }
        .area-code { font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; background: var(--bg-body); color: var(--text-main); }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-4xl card-dynamic overflow-hidden">
        
        <header class="header-bg px-8 py-6 text-white flex flex-col md:flex-row justify-between items-center gap-6 relative">
            <div class="flex items-center gap-5 z-10">
                <div class="bg-white/10 p-3.5 rounded-2xl border border-white/20 backdrop-blur-md shadow-inner">
                    <i class="fa-solid fa-file-signature text-2xl"></i>
                </div>
                <div>
                    <h2 class="text-[11px] font-bold text-red-100/80 uppercase tracking-widest mb-1">Unidad SUISD</h2>
                    <h1 class="text-xl md:text-2xl font-black leading-none tracking-tight font-display">SEDES LA PAZ - SUISD</h1>
                    <p class="text-white/80 text-xs font-bold mt-1 tracking-wide">GESTIÓN DE ENTREGA - CERTIFICADOS CEMEUD</p>
                </div>
            </div>

            <div class="flex items-center gap-4 z-10">
                <button onclick="toggleTheme()" class="btn-theme-toggle" id="themeBtn" title="Cambiar Tema"><i class="fa-solid fa-moon"></i></button>
                <div id="statusBadge" class="bg-black/20 px-3 py-1.5 rounded-full border border-white/20 text-[10px] font-bold uppercase tracking-wider backdrop-blur-sm">
                    <span class="w-2 h-2 rounded-full bg-slate-300 animate-pulse inline-block mr-1"></span> Esperando
                </div>
                <a href="admin.html" class="bg-white/10 hover:bg-white/20 text-white border border-white/20 px-4 py-2 rounded-xl text-xs font-bold uppercase transition flex items-center gap-2 backdrop-blur-sm" style="text-decoration:none;">
                    <i class="fa-solid fa-user-shield"></i> Admin
                </a>
            </div>
        </header>

        <form id="mainForm" class="p-6 md:p-10" autocomplete="off">
            
            <div id="alertDeuda" class="hidden mb-8 bg-red-50 border-l-4 border-red-600 p-4 rounded-r-lg flex items-center gap-4 shadow-sm border border-red-100">
                <div class="text-red-600 text-2xl"><i class="fa-solid fa-triangle-exclamation"></i></div>
                <div>
                    <h3 class="text-xs font-black text-red-900 uppercase tracking-wide">Deuda Pendiente</h3>
                    <p class="text-sm text-red-700 font-medium">Debe devolver <span id="txtSaldo" class="font-black text-lg bg-white px-2 rounded border border-red-200 text-red-800">0</span> certificados.</p>
                </div>
            </div>

            <div class="card-dynamic p-6 mb-6 relative" style="border: 1px solid var(--border-color); box-shadow: none; background: var(--bg-body);">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="relative flex">
                        <div class="w-full relative">
                            <input type="number" id="inputCI" name="ci" class="input-field font-bold text-lg" style="border-radius: 0.75rem 0 0 0.75rem; border-right: none;" placeholder=" " required>
                            <label class="input-label">Cédula de Identidad</label>
                        </div>
                        <button type="button" onclick="buscarFuncionario()" id="btnBuscar" class="btn-search" title="Buscar Funcionario"><i class="fa-solid fa-magnifying-glass text-lg"></i></button>
                    </div>
                    <div class="input-group md:col-span-2">
                        <input type="text" id="inputInst" name="institucion" class="input-field font-bold" placeholder=" " required oninput="this.value = this.value.toUpperCase()">
                        <label class="input-label">Institución / Centro de Salud</label>
                    </div>
                    <div class="input-group">
                        <input type="text" id="inputNom" name="nombres" class="input-field" placeholder=" " required oninput="this.value = this.value.toUpperCase()">
                        <label class="input-label">Nombres</label>
                    </div>
                    <div class="input-group md:col-span-2">
                        <input type="text" id="inputApe" name="apellidos" class="input-field" placeholder=" " required oninput="this.value = this.value.toUpperCase()">
                        <label class="input-label">Apellidos</label>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div id="boxDevolucion" class="card-dynamic p-5 border-l-4" style="border-left-color: #64748b;">
                    <div class="flex items-center gap-2 mb-4" style="color: var(--text-muted);">
                        <i class="fa-solid fa-arrow-rotate-left"></i>
                        <h3 class="text-xs font-bold uppercase tracking-wider">Devolución (Baja)</h3>
                    </div>
                    <div class="input-group">
                        <input type="number" name="nro_devueltos" id="nroDev" class="input-field text-center font-bold text-xl" placeholder=" " oninput="syncDesdeCantidad()">
                        <label class="input-label">Cantidad</label>
                    </div>
                    <div class="relative">
                        <textarea name="codigos_devueltos" id="txtDev" class="input-field area-code h-32 resize-none pt-4" placeholder=" " oninput="this.value = this.value.toUpperCase(); syncDesdeTexto()"></textarea>
                        <label class="input-label">Códigos (Escanee o Escriba)</label>
                    </div>
                </div>

                <div class="card-dynamic p-5 border-l-4" style="border-left-color: #be123c; background: linear-gradient(to bottom right, var(--bg-card), rgba(190, 18, 60, 0.05));">
                    <div class="flex items-center gap-2 mb-4 text-red-700">
                        <i class="fa-solid fa-hand-holding-hand"></i>
                        <h3 class="text-xs font-bold uppercase tracking-wider">Entrega (Nuevos)</h3>
                    </div>
                    <div class="input-group relative">
                        <input type="number" name="nro_recogidos" id="nroEnt" class="input-field text-center font-bold text-xl text-red-700" style="border-color: #fca5a5;" placeholder=" " onchange="obtenerStock()">
                        <label class="input-label text-red-700">Cantidad a Entregar</label>
                        <div class="absolute right-4 top-3 text-red-400 pointer-events-none text-lg"><i class="fa-solid fa-wand-magic-sparkles"></i></div>
                    </div>
                    <div class="relative">
                        <textarea name="codigos_recogidos" id="txtEnt" class="input-field area-code h-32 resize-none pt-4 text-red-700" style="border-color: #fca5a5;" placeholder=" " readonly></textarea>
                        <label class="input-label text-red-700">Códigos Generados</label>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                 <div class="md:col-span-1 card-dynamic p-4">
                    <div class="input-group h-full mb-0">
                        <textarea name="observacion" id="inputObs" class="input-field h-full min-h-[150px] resize-none pt-4 text-xs leading-relaxed" placeholder=" " oninput="this.value = this.value.toUpperCase()"></textarea>
                        <label class="input-label">Observaciones (Opcional)</label>
                    </div>
                </div>
                <div class="md:col-span-2 card-dynamic p-4 relative">
                     <div class="flex justify-between items-center mb-3">
                        <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest flex items-center gap-2">
                            <i class="fa-solid fa-pen-nib text-blue-700"></i> Firma de Conformidad
                        </h3>
                        <span class="text-[10px] text-blue-700 font-bold uppercase bg-blue-50 px-2 py-1 rounded border border-blue-100">Tinta Azul</span>
                    </div>
                    <div class="signature-wrapper">
                        <canvas id="signature-pad"></canvas>
                         <button type="button" class="absolute bottom-3 right-3 bg-white text-slate-600 hover:text-red-600 px-3 py-1 rounded text-[10px] font-bold border border-slate-300 shadow-sm transition uppercase z-10" onclick="limpiarFirma()">
                            <i class="fa-solid fa-eraser mr-1"></i> Limpiar
                        </button>
                    </div>
                </div>
            </div>

            <div class="text-center pt-2">
                <button type="button" onclick="verificarYEnviar()" class="btn-action">
                    <i class="fa-regular fa-circle-check mr-2"></i> CONFIRMAR Y REGISTRAR
                </button>
            </div>
        </form>
    </div>

    <script>
        // ==========================================
        // ⚠️ PEGA AQUÍ TU URL
        const URL_API = "https://script.google.com/macros/s/AKfycbxJoLudHYzMH_Tn5tBMDPFHQ153SRDkvK9Wu4lDRPLMoGX7McDIkS-Gon2_tQoEq09F/exec"; 
        // ==========================================

        // --- GESTIÓN DE TEMAS ---
        function toggleTheme() {
            const html = document.documentElement;
            const btn = document.getElementById('themeBtn');
            if (html.getAttribute('data-theme') === 'light') {
                html.setAttribute('data-theme', 'dark');
                btn.innerHTML = '<i class="fa-solid fa-sun text-yellow-400"></i>';
                localStorage.setItem('theme', 'dark');
            } else {
                html.setAttribute('data-theme', 'light');
                btn.innerHTML = '<i class="fa-solid fa-moon"></i>';
                localStorage.setItem('theme', 'light');
            }
        }
        if(localStorage.getItem('theme') === 'dark') { toggleTheme(); }

        const btnBuscar=document.getElementById('btnBuscar'), boxDev=document.getElementById('boxDevolucion'), badge=document.getElementById('statusBadge');
        let deudaTotalCodigos = [], signaturePad;

        document.addEventListener('DOMContentLoaded', () => {
            const canvas = document.getElementById('signature-pad');
            function resizeCanvas() { const ratio = Math.max(window.devicePixelRatio || 1, 1); canvas.width = canvas.offsetWidth * ratio; canvas.height = canvas.offsetHeight * ratio; canvas.getContext("2d").scale(ratio, ratio); }
            window.onresize = resizeCanvas; resizeCanvas();
            signaturePad = new SignaturePad(canvas, { backgroundColor: 'rgba(255,255,255,0)', penColor: '#00008b', minWidth: 0.5, maxWidth: 2.0 });
        });

        function limpiarFirma() { signaturePad.clear(); }

        // BUSCADOR
        function buscarFuncionario() {
            const ci=document.getElementById('inputCI').value; if(!ci){Swal.fire({title:'Atención',text:'Ingrese el CI del funcionario',icon:'warning',confirmButtonColor:'#991b1b'});return;}
            const ico=btnBuscar.innerHTML; btnBuscar.innerHTML='<i class="fa-solid fa-circle-notch fa-spin"></i>'; btnBuscar.disabled=true;
            fetch(URL_API,{method:"POST",body:JSON.stringify({action:"buscar_funcionario",ci:ci})}).then(r=>r.json()).then(res=>{
                btnBuscar.innerHTML=ico; btnBuscar.disabled=false;
                if(res.status==='success' && res.encontrado){
                    habilitarDev(true); document.getElementById('inputNom').value=res.datos.nombres; document.getElementById('inputApe').value=res.datos.apellidos; document.getElementById('inputInst').value=res.datos.institucion; document.getElementById('inputObs').value=res.datos.observacion||'';
                    badge.className="bg-green-100 text-green-800 border border-green-200 px-3 py-1 rounded-full text-[10px] font-bold uppercase"; badge.innerHTML='<i class="fa-solid fa-check mr-1"></i> Registrado';
                    if(res.saldo>0){ document.getElementById('alertDeuda').classList.remove('hidden'); document.getElementById('txtSaldo').innerText=res.saldo; deudaTotalCodigos=res.lista_codigos.split(',').map(c=>c.trim()); document.getElementById('nroDev').value=res.saldo; document.getElementById('txtDev').value=res.lista_codigos; }
                    else{ deudaTotalCodigos=[]; document.getElementById('alertDeuda').classList.add('hidden'); limpiarDev(); }
                } else { habilitarDev(false); limpiarDatos(); badge.className="bg-blue-100 text-blue-800 border border-blue-200 px-3 py-1 rounded-full text-[10px] font-bold uppercase"; badge.innerHTML='<i class="fa-solid fa-plus mr-1"></i> Nuevo'; }
            }).catch(()=>{ btnBuscar.innerHTML=ico; btnBuscar.disabled=false; Swal.fire('Error','Fallo de conexión.','error'); });
        }

        // LOGICA UI
        function syncDesdeTexto(){ const t=document.getElementById('txtDev').value; const c=t.split(/[\n, ]+/).filter(x=>x.trim()!==''); document.getElementById('nroDev').value=c.length; }
        function syncDesdeCantidad(){ if(deudaTotalCodigos.length===0)return; const n=parseInt(document.getElementById('nroDev').value)||0; const s=deudaTotalCodigos.slice(0,n); document.getElementById('txtDev').value=s.join(', '); }
        function obtenerStock(){ const c=document.getElementById('nroEnt').value, t=document.getElementById('txtEnt'); if(!c||c<=0){t.value='';return;} t.classList.add('animate-pulse'); t.value='GENERANDO...'; fetch(URL_API,{method:"POST",body:JSON.stringify({action:"obtener_auto_codigos",cantidad:c})}).then(r=>r.json()).then(res=>{ t.classList.remove('animate-pulse'); if(res.status==='success')t.value=res.codigos; else { t.value=''; Swal.fire('Error',res.message,'error'); } }); }

        // CONFIRMACIÓN DINÁMICA
        function verificarYEnviar() {
            const f = document.getElementById('mainForm'); if(!f.checkValidity()){ f.reportValidity(); return; }
            if (signaturePad.isEmpty()) { Swal.fire({ icon: 'warning', title: 'Falta la Firma', text: 'El funcionario debe firmar en el recuadro blanco.', confirmButtonColor: '#991b1b' }); return; }
            
            const d = Object.fromEntries(new FormData(f).entries());
            if(boxDev.classList.contains('disabled-section')) { d.nro_devueltos=0; d.codigos_devueltos='---'; }
            const firmaBase64 = signaturePad.toDataURL("image/png");

            // HTML DETALLADO EN BLANCO PARA QUE SE LEA SIEMPRE
            const htmlVerify = `
                <div class="swal-container-custom">
                    <div class="conf-box">
                        <div class="conf-title">FUNCIONARIO</div>
                        <div class="conf-row"><span>Nombre:</span> <span class="conf-val">${d.nombres} ${d.apellidos}</span></div>
                        <div class="conf-row"><span>CI:</span> <span class="conf-val">${d.ci}</span></div>
                        <div class="conf-row"><span>Institución:</span> <span class="conf-val">${d.institucion}</span></div>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div class="conf-box bg-slate-50 border-slate-200">
                            <div class="conf-title text-slate-500">DEVOLUCIÓN</div>
                            <div class="text-xl font-black text-slate-700">${d.nro_devueltos||0}</div>
                            <div class="conf-code text-slate-500">${d.codigos_devueltos||'-'}</div>
                        </div>
                        <div class="conf-box bg-red-50 border-red-100">
                            <div class="conf-title text-red-500">ENTREGA</div>
                            <div class="text-xl font-black text-red-700">${d.nro_recogidos||0}</div>
                            <div class="conf-code text-red-900">${d.codigos_recogidos||'-'}</div>
                        </div>
                    </div>
                    ${d.observacion ? `<div class="conf-box bg-yellow-50 border-yellow-200 text-yellow-800 text-xs"><b>OBS:</b> ${d.observacion}</div>` : ''}
                    <div class="text-center mt-2">
                        <div class="text-[10px] font-bold text-blue-600 uppercase mb-1">Firma Capturada</div>
                        <img src="${firmaBase64}" style="height:60px;margin:0 auto;border:1px dashed #ccc;padding:2px;border-radius:4px;background:white;">
                    </div>
                </div>`;

            Swal.fire({
                title: 'VERIFICAR DATOS',
                html: htmlVerify,
                icon: 'question',
                width: '500px',
                showCancelButton: true,
                confirmButtonText: 'SÍ, REGISTRAR',
                confirmButtonColor: '#166534',
                cancelButtonText: 'Corregir',
                cancelButtonColor: '#64748b',
                background: '#fff', // Fondo blanco forzado en modal
                color: '#1e293b'
            }).then((result) => { if (result.isConfirmed) enviarDatos(d, firmaBase64); });
        }

        function enviarDatos(d, firma) {
            Swal.fire({title:'Guardando...', text:'Procesando registro...', allowOutsideClick:false, didOpen:()=>Swal.showLoading()});
            
            // Asegurar mayúsculas
            d.nombres=d.nombres.toUpperCase(); d.apellidos=d.apellidos.toUpperCase();
            d.institucion=d.institucion.toUpperCase(); d.observacion=d.observacion.toUpperCase();
            d.codigos_devueltos=d.codigos_devueltos.toUpperCase();
            
            const payload = Object.assign(d, { action: 'registrar', firma: firma });
            
            fetch(URL_API, {method:'POST', body:JSON.stringify(payload)})
            .then(r => r.json()).then(res => {
                if(res.status==='success') { 
                    Swal.fire({ icon: 'success', title: '¡REGISTRO EXITOSO!', text: 'Los datos se guardaron correctamente.', timer: 2000, showConfirmButton: false });
                    resetAll();
                } else Swal.fire('Error', res.message, 'error');
            }).catch(e => Swal.fire('Error Crítico', e.message, 'error'));
        }

        function habilitarDev(s) { if(s) boxDev.classList.remove('disabled-section'); else { boxDev.classList.add('disabled-section'); limpiarDev(); } }
        function limpiarDatos() { document.getElementById('inputNom').value=''; document.getElementById('inputApe').value=''; document.getElementById('inputInst').value=''; document.getElementById('inputObs').value=''; }
        function limpiarDev() { document.getElementById('nroDev').value=''; document.getElementById('txtDev').value=''; }
        function resetAll() { document.getElementById('mainForm').reset(); limpiarDatos(); limpiarDev(); limpiarFirma(); badge.className="bg-black/20 px-3 py-1.5 rounded-full border border-white/20 text-[10px] font-bold uppercase tracking-wider backdrop-blur-sm text-slate-500"; badge.innerHTML='<span class="w-2 h-2 rounded-full bg-slate-300 animate-pulse inline-block mr-1"></span> Esperando'; document.getElementById('alertDeuda').classList.add('hidden'); habilitarDev(true); deudaTotalCodigos = []; document.getElementById('txtEnt').value=''; }
    </script>
</body>
</html>