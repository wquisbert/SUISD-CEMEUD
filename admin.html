<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEMEUD | Admin Live Sync</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&family=Outfit:wght@500;700;800&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">

    <style>
        /* TEMA */
        :root {
            --bg-body: #f1f5f9; --bg-card: #ffffff; --text-main: #1e293b; --text-muted: #64748b;
            --border-color: #e2e8f0; --accent: #be123c;
            --header-grad-1: #991b1b; --header-grad-2: #7f1d1d;
        }
        [data-theme="dark"] {
            --bg-body: #0f172a; --bg-card: #1e293b; --text-main: #f1f5f9; --text-muted: #94a3b8;
            --border-color: #334155; --accent: #f43f5e;
            --header-grad-1: #450a0a; --header-grad-2: #7f1d1d;
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-main); font-size: 0.85rem; overflow: hidden; transition: 0.3s; }
        
        /* LOGIN */
        #login-screen { position: fixed; inset: 0; z-index: 100; background: #0f172a; display: flex; align-items: center; justify-content: center; transition: 0.5s; }
        
        /* HEADER */
        .header-bg { background: linear-gradient(135deg, var(--header-grad-1), var(--header-grad-2)); box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
        .nav-btn { padding: 6px 14px; border-radius: 6px; font-weight: 700; font-size: 0.75rem; color: rgba(255,255,255,0.7); display: flex; align-items: center; gap: 6px; transition: 0.2s; }
        .nav-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .nav-btn.active { background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.2); backdrop-filter: blur(5px); }

        /* TABLA DETALLADA */
        .table-tight { width: 100%; border-collapse: separate; border-spacing: 0; }
        .thead-modern th { background: var(--bg-card); padding: 12px; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; color: var(--text-muted); border-bottom: 2px solid var(--border-color); position: sticky; top: 0; z-index: 10; text-align: left; }
        .tbody-modern td { padding: 12px; vertical-align: top; border-bottom: 1px solid var(--border-color); }
        .tbody-modern tr:hover td { background-color: rgba(0,0,0,0.02); }

        /* ELEMENTOS DE CÓDIGO (SCROLLABLE) */
        .code-box { 
            max-height: 80px; overflow-y: auto; font-family: 'JetBrains Mono', monospace; 
            font-size: 0.7rem; background: var(--bg-body); border: 1px solid var(--border-color); 
            padding: 6px; border-radius: 6px; margin-top: 4px; line-height: 1.4; color: var(--text-main);
            white-space: pre-wrap; word-break: break-word;
        }
        
        .sig-preview { 
            height: 60px; width: 100px; display: flex; align-items: center; justify-content: center;
            background: #fff; border: 1px dashed var(--border-color); border-radius: 6px; padding: 2px;
        }
        .sig-preview img { max-height: 100%; max-width: 100%; cursor: zoom-in; transition: transform 0.2s; }
        .sig-preview img:hover { transform: scale(3); z-index: 50; background: white; border: 1px solid var(--border-color); box-shadow: 0 10px 20px rgba(0,0,0,0.2); padding: 5px; border-radius: 4px; }

        /* BOTONES ACCIÓN */
        .action-flex { display: flex; gap: 5px; justify-content: flex-end; }
        .btn-act { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; transition: 0.2s; border: 1px solid transparent; cursor: pointer; }
        .act-edit { background: #eff6ff; color: #2563eb; border-color: #dbeafe; } .act-edit:hover { background: #2563eb; color: white; }
        .act-print { background: #f0fdf4; color: #16a34a; border-color: #dcfce7; } .act-print:hover { background: #16a34a; color: white; }
        .act-del { background: #fef2f2; color: #ef4444; border-color: #fee2e2; } .act-del:hover { background: #ef4444; color: white; }

        /* MODALES */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(3px); z-index: 60; display: none; align-items: center; justify-content: center; }
        .modal-box { background: white; border-radius: 16px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); overflow: hidden; }
        
        .custom-scroll::-webkit-scrollbar { width: 5px; height: 5px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        /* PDF TEMPLATE OCULTO */
        #pdf-template { display: none; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-96 text-center border border-slate-200">
            <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl"><i class="fa-solid fa-user-lock text-slate-700"></i></div>
            <h1 class="text-2xl font-black text-slate-800 font-[Outfit] mb-6">ADMINISTRACIÓN</h1>
            <input type="password" id="loginPass" class="w-full border-2 border-slate-100 p-3 rounded-xl mb-4 text-center font-bold outline-none focus:border-slate-400 transition" placeholder="Contraseña">
            <button onclick="login()" class="w-full bg-slate-900 text-white py-3 rounded-xl font-bold hover:bg-black transition shadow-lg">INGRESAR</button>
            <button onclick="window.location.href='index.html'" class="mt-4 text-xs text-slate-400 hover:text-slate-600 underline">Volver al Registro</button>
        </div>
    </div>

    <div id="secure-content" style="display:none; height: 100vh; flex-direction: column;">
        <header class="header-bg h-16 flex-none px-6 flex justify-between items-center z-40">
            <div class="flex items-center gap-6">
                <div class="flex items-center gap-3 text-white">
                    <div class="bg-white/10 p-2 rounded-lg border border-white/20"><i class="fa-solid fa-server text-lg"></i></div>
                    <div><h1 class="font-bold font-[Outfit] text-lg leading-tight">CEMEUD</h1><p class="text-[10px] opacity-70 font-bold uppercase tracking-wide">Panel de Control</p></div>
                </div>
                <div class="flex bg-black/20 p-1 rounded-lg backdrop-blur-sm">
                    <button onclick="switchTab('mov')" id="tab-mov" class="nav-btn active"><i class="fa-solid fa-table-cells"></i> DETALLE REGISTROS</button>
                    <button onclick="switchTab('inv')" id="tab-inv" class="nav-btn"><i class="fa-solid fa-boxes-stacked"></i> INVENTARIO</button>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <div class="flex items-center gap-2 bg-white/10 p-1.5 rounded-lg border border-white/20">
                    <input type="date" id="dateStart" class="bg-transparent text-[10px] font-bold text-white outline-none w-24" onchange="filtrarYPaginar()">
                    <span class="text-white/50">-</span>
                    <input type="date" id="dateEnd" class="bg-transparent text-[10px] font-bold text-white outline-none w-24" onchange="filtrarYPaginar()">
                    <button onclick="limpiarFechas()" class="text-white/50 hover:text-white px-1"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <button onclick="recargarTodo()" class="w-9 h-9 rounded-lg bg-white/10 hover:bg-white/20 text-white flex items-center justify-center transition" title="Actualizar"><i class="fa-solid fa-rotate"></i></button>
                <button onclick="generarReporteVisual()" class="bg-white text-rose-900 px-4 py-2 rounded-lg text-xs font-bold shadow hover:bg-slate-100 transition flex items-center gap-2"><i class="fa-solid fa-list"></i> Reporte Gral.</button>
                <button onclick="logout()" class="w-9 h-9 rounded-lg bg-red-500/80 hover:bg-red-600 text-white flex items-center justify-center transition ml-2" title="Cerrar Sesión"><i class="fa-solid fa-power-off"></i></button>
            </div>
        </header>

        <main class="flex-1 overflow-hidden p-6 flex flex-col gap-6">
            <div id="stats-panel" class="grid grid-cols-4 gap-4 flex-none h-28">
                <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm flex items-center justify-between"><div><p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">TOTAL REGISTROS</p><h3 class="text-3xl font-black text-slate-800" id="stat-tot">0</h3></div><div class="p-3 bg-slate-50 rounded-xl text-slate-400"><i class="fa-solid fa-database text-xl"></i></div></div>
                <div class="bg-white p-2 rounded-2xl border border-slate-200 shadow-sm flex col-span-1 relative overflow-hidden"><canvas id="chartMini" class="w-full h-full"></canvas></div>
                <div class="col-span-2 grid grid-cols-3 gap-3">
                    <div class="bg-emerald-50 p-3 rounded-xl border border-emerald-100 flex flex-col items-center justify-center"><span class="text-[10px] font-bold text-emerald-700 uppercase">Stock Disp.</span><div class="text-2xl font-black text-emerald-700" id="stat-disp">0</div></div>
                    <div class="bg-rose-50 p-3 rounded-xl border border-rose-100 flex flex-col items-center justify-center"><span class="text-[10px] font-bold text-rose-700 uppercase">Entregados</span><div class="text-2xl font-black text-rose-700" id="stat-ent">0</div></div>
                    <div class="bg-slate-100 p-3 rounded-xl border border-slate-200 flex flex-col items-center justify-center"><span class="text-[10px] font-bold text-slate-500 uppercase">Devueltos</span><div class="text-2xl font-black text-slate-600" id="stat-dev">0</div></div>
                </div>
            </div>

            <div class="bg-white rounded-2xl border border-slate-200 shadow-sm flex-1 flex flex-col overflow-hidden">
                <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-white z-20">
                    <div class="relative w-80"><i class="fa-solid fa-search absolute left-3 top-3 text-slate-400 text-xs"></i><input id="globalSearch" onkeyup="filtrarYPaginar()" type="text" class="w-full pl-10 pr-4 py-2.5 border border-slate-200 rounded-xl text-xs font-bold text-slate-700 bg-slate-50 focus:bg-white focus:border-blue-500 outline-none transition" placeholder="Buscar por Nombre, CI, Código..."></div>
                    <div id="inv-controls" class="hidden flex gap-2">
                        <button onclick="setInvFilter('DISPONIBLE')" class="px-3 py-1 bg-emerald-50 text-emerald-700 rounded-lg border border-emerald-200 text-[10px] font-bold hover:bg-emerald-100">DISP</button>
                        <button onclick="setInvFilter('ENTREGADO')" class="px-3 py-1 bg-rose-50 text-rose-700 rounded-lg border border-rose-200 text-[10px] font-bold hover:bg-rose-100">ENT</button>
                        <button onclick="setInvFilter('DEVUELTO')" class="px-3 py-1 bg-slate-100 text-slate-600 rounded-lg border border-slate-200 text-[10px] font-bold hover:bg-slate-100">DEV</button>
                        <div class="w-px h-6 bg-slate-200 mx-2"></div>
                        <button onclick="openModalLote()" class="bg-slate-900 text-white px-4 py-1.5 rounded-lg text-[10px] font-bold hover:bg-black transition shadow flex items-center gap-2"><i class="fa-solid fa-plus"></i> NUEVO LOTE</button>
                    </div>
                </div>

                <div class="flex-1 overflow-auto custom-scroll relative bg-white">
                    <table id="table-mov" class="table-tight w-full">
                        <thead class="thead-modern">
                            <tr>
                                <th style="width: 100px;">FECHA</th>
                                <th style="width: 25%;">DATOS DEL FUNCIONARIO</th>
                                <th style="width: 20%;">DEVOLUCIÓN (BAJA)</th>
                                <th style="width: 20%;">ENTREGA (NUEVOS)</th>
                                <th style="width: 100px; text-align:center;">FIRMA</th>
                                <th style="width: 15%;">OBSERVACIÓN</th>
                                <th style="width: 110px; text-align:right;">ACCIONES</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-mov" class="tbody-modern text-slate-600"></tbody>
                    </table>
                    
                    <table id="table-inv" class="table-tight w-full hidden">
                        <thead class="thead-modern">
                            <tr>
                                <th style="width: 150px;">CÓDIGO ÚNICO</th>
                                <th style="width: 120px;">ESTADO</th>
                                <th>DETALLE DE MOVIMIENTO</th>
                                <th style="width: 80px; text-align:right;">GESTIÓN</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-inv" class="tbody-modern text-slate-600"></tbody>
                    </table>
                </div>
                
                <div class="p-3 border-t border-slate-100 bg-slate-50 flex justify-between items-center text-[11px] font-bold text-slate-500">
                    <span id="pag-info">Cargando datos...</span>
                    <div class="flex gap-2">
                        <button onclick="cambiarPagina(-1)" class="px-3 py-1 bg-white border rounded hover:bg-slate-100">ANTERIOR</button>
                        <button onclick="cambiarPagina(1)" class="px-3 py-1 bg-white border rounded hover:bg-slate-100">SIGUIENTE</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="modalLote" class="modal-overlay">
        <div class="modal-box w-96 p-6">
            <h3 class="font-black text-lg mb-4 text-slate-800 flex justify-between">GENERAR LOTE <button onclick="closeModalLote()" class="text-slate-400 font-normal hover:text-red-500">✕</button></h3>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div><label class="text-[10px] font-bold text-slate-400 uppercase">Inicio</label><input id="loteIni" type="number" class="w-full border p-2 rounded text-center font-bold" oninput="updatePreview()"></div>
                <div><label class="text-[10px] font-bold text-slate-400 uppercase">Fin</label><input id="loteFin" type="number" class="w-full border p-2 rounded text-center font-bold" oninput="updatePreview()"></div>
            </div>
            <select id="loteCeros" class="w-full border p-2 rounded mb-4 text-sm" onchange="updatePreview()"><option value="5">5 Dígitos (00001)</option><option value="6">6 Dígitos (000001)</option></select>
            <div class="bg-slate-100 p-3 rounded mb-4 text-center border border-slate-200">
                <div id="codePreview" class="font-mono font-bold text-lg text-slate-700">00000</div>
                <div id="countPreview" class="text-xs text-green-600 font-bold mt-1">0 certificados</div>
            </div>
            <button onclick="generarLote()" class="w-full bg-slate-900 text-white py-2 rounded font-bold hover:bg-black">CONFIRMAR</button>
        </div>
    </div>

    <div id="modalEdit" class="modal-overlay"><div class="modal-box w-[600px]"><div class="bg-slate-800 p-4 text-white font-bold flex justify-between text-sm"><span>EDITAR REGISTRO</span><button onclick="document.getElementById('modalEdit').style.display='none'">✕</button></div><div class="p-6 text-xs space-y-4"><input type="hidden" id="edFila"><div class="grid grid-cols-2 gap-4"><div><label class="font-bold text-slate-500">CI</label><input id="edCi" class="w-full border p-2.5 rounded-lg bg-slate-50 font-bold"></div><div><label class="font-bold text-slate-500">INSTITUCIÓN</label><input id="edInst" class="w-full border p-2.5 rounded-lg bg-slate-50 uppercase"></div><div><label class="font-bold text-slate-500">NOMBRES</label><input id="edNom" class="w-full border p-2.5 rounded-lg bg-slate-50 uppercase"></div><div><label class="font-bold text-slate-500">APELLIDOS</label><input id="edApe" class="w-full border p-2.5 rounded-lg bg-slate-50 uppercase"></div></div><div class="grid grid-cols-2 gap-4 border-t pt-4"><div class="bg-slate-50 p-3 border rounded-lg"><label class="font-bold text-center block mb-2 text-slate-600">DEVOLUCIÓN</label><input id="edDevCant" class="w-full border p-1.5 text-center font-bold mb-2 rounded bg-white"><textarea id="edDevCod" class="w-full border p-2 h-16 font-mono text-[10px] rounded bg-white"></textarea></div><div class="bg-rose-50 p-3 border border-rose-100 rounded-lg"><label class="font-bold text-center block mb-2 text-rose-700">ENTREGA</label><input id="edRecCant" class="w-full border p-1.5 text-center font-bold mb-2 rounded bg-white text-rose-700"><textarea id="edRecCod" class="w-full border p-2 h-16 font-mono text-[10px] rounded bg-white border-rose-200"></textarea></div></div><div><label class="font-bold text-slate-500">OBSERVACIONES</label><textarea id="edObs" class="w-full border p-3 rounded-lg h-14 bg-slate-50"></textarea></div><button onclick="guardarEdicion()" class="w-full bg-slate-900 text-white py-3 rounded-xl font-bold hover:bg-black transition shadow">GUARDAR CAMBIOS</button></div></div></div>

    <div id="pdfModal" class="modal-overlay">
        <div class="bg-white w-[800px] h-[90vh] rounded-xl flex flex-col overflow-hidden shadow-2xl">
            <div class="bg-slate-800 text-white p-3 flex justify-between items-center shadow-md">
                <div class="font-bold text-sm flex items-center gap-2"><i class="fa-solid fa-file-pdf"></i> ACTA DE ENTREGA</div>
                <div class="flex gap-2">
                    <button onclick="document.getElementById('pdfModal').style.display='none'" class="px-3 py-1 rounded text-xs bg-white/10 hover:bg-white/20">Cerrar</button>
                    <button id="btnDownload" class="px-3 py-1 rounded text-xs bg-white text-slate-900 font-bold hover:bg-slate-100">Descargar</button>
                </div>
            </div>
            <div class="flex-1 bg-slate-200 relative"><iframe id="pdfFrame" class="w-full h-full border-none"></iframe></div>
        </div>
    </div>

    <div id="pdf-template" style="display:none;width:750px;padding:20px;box-sizing:border-box;">
        <div style="border:2px solid #000;padding:20px;height:100%;">
            <div style="display:flex;border-bottom:2px solid #000;padding-bottom:10px;margin-bottom:15px;align-items:center;">
                <div style="width:60px;text-align:center;font-size:35px;font-weight:bold;border:2px solid #000;border-radius:50%;height:50px;line-height:45px;margin-right:15px;">S</div>
                <div style="flex-grow:1;text-align:center;"><div style="font-size:12px;font-weight:bold;">ESTADO PLURINACIONAL DE BOLIVIA</div><div style="font-size:10px;font-weight:bold;">UNIDAD DE ESTADÍSTICAS (CEMEUD)</div><div style="font-size:14px;font-weight:bold;text-decoration:underline;margin-top:5px;">ACTA DE ENTREGA</div></div>
                <div style="text-align:right;font-size:10px;border:1px solid #000;padding:5px;"><b>ID:</b> <span id="pdf-ctrl"></span><br><b>FECHA:</b> <span id="pdf-fecha"></span></div>
            </div>
            <div style="font-size:11px;font-weight:bold;background:#eee;border:1px solid #000;padding:3px;">I. DATOS DEL FUNCIONARIO</div>
            <table style="width:100%;border-collapse:collapse;font-size:11px;margin-bottom:10px;"><tr><td style="border:1px solid #000;padding:5px;" width="70%"><b>NOMBRE:</b> <span id="pdf-nombre"></span></td><td style="border:1px solid #000;padding:5px;"><b>CI:</b> <span id="pdf-ci"></span></td></tr><tr><td colspan="2" style="border:1px solid #000;padding:5px;"><b>INSTITUCIÓN:</b> <span id="pdf-inst"></span></td></tr></table>
            <div style="font-size:11px;font-weight:bold;background:#eee;border:1px solid #000;padding:3px;">II. DETALLE DE VALORES</div>
            <table style="width:100%;border-collapse:collapse;font-size:11px;"><tr><th style="border:1px solid #000;padding:5px;">DEVOLUCIÓN</th><th style="border:1px solid #000;padding:5px;">ENTREGA</th></tr><tr><td style="border:1px solid #000;padding:5px;vertical-align:top;"><b>CANT:</b> <span id="pdf-dev-cant"></span><br><div style="font-family:'Courier New';word-break:break-all;" id="pdf-dev-cod"></div></td><td style="border:1px solid #000;padding:5px;vertical-align:top;"><b>CANT:</b> <span id="pdf-rec-cant"></span><br><div style="font-family:'Courier New';word-break:break-all;" id="pdf-rec-cod"></div></td></tr></table>
            <div style="border:1px solid #000;padding:5px;font-size:10px;margin-top:5px;"><b>OBS:</b> <span id="pdf-obs"></span></div>
            <div style="margin-top:40px;display:flex;justify-content:space-around;text-align:center;"><div style="width:40%;"><img id="pdf-sign-img" style="height:60px;margin-bottom:-10px;"><div style="border-top:1px solid #000;font-size:10px;font-weight:bold;">FIRMA FUNCIONARIO</div><div style="font-size:9px;">CI: <span id="pdf-sign-ci"></span></div></div><div style="width:40%;margin-top:50px;"><div style="border-top:1px solid #000;font-size:10px;font-weight:bold;">RESPONSABLE CEMEUD</div></div></div>
        </div>
    </div>

    <div id="loader" class="fixed inset-0 bg-white/90 hidden flex-col items-center justify-center z-50"><div class="w-12 h-12 border-4 border-slate-200 border-t-rose-600 rounded-full animate-spin"></div><span class="text-xs font-bold mt-3 text-slate-400 tracking-widest">PROCESANDO...</span></div>

    <script>
        const URL_API = "https://script.google.com/macros/s/AKfycbyyoAkAmkEWK1U2MF-RyDawsQx2E1BvCjNkKU_QDts_SPweMbem-7vc1okgWjjTJu30/exec"; 
        
        function login(){ if(document.getElementById('loginPass').value==='SUISD'){ sessionStorage.setItem('auth','true'); initApp(); } else Swal.fire('Error','Contraseña Incorrecta','error'); }
        function logout(){ sessionStorage.removeItem('auth'); location.reload(); }
        function initApp(){ document.getElementById('login-screen').style.display='none'; document.getElementById('secure-content').style.display='flex'; cargarTodo(); }
        
        document.addEventListener('DOMContentLoaded', ()=>{ if(sessionStorage.getItem('auth')==='true') initApp(); });

        let dMov=[], dInv=[], fData=[], currTab='mov', invFilter='DISPONIBLE', codeMap={}, page=1; const rowsPerPage=10;

        function cargarTodo() { load(true); Promise.all([fetch(URL_API,{method:'POST',body:JSON.stringify({action:'leer_registros'})}).then(r=>r.json()), fetch(URL_API,{method:'POST',body:JSON.stringify({action:'leer_inventario'})}).then(r=>r.json())]).then(([rMov,rInv])=>{ load(false); if(rMov.status==='success') dMov=rMov.data; if(rInv.status==='success') dInv=rInv.data; buildMap(); updateStats(); filtrarYPaginar(); }).catch(()=>{load(false);}); }

        function buildMap() {
            codeMap = {};
            [...dMov].reverse().forEach(m => {
                String(m.cod_rec).split(/[\n,]+/).forEach(c=>{if(c)codeMap[c.trim()]={type:'ENT',nom:m.apellidos+' '+m.nombres,ci:m.ci,date:m.fecha}});
                String(m.cod_dev).split(/[\n,]+/).forEach(c=>{if(c)codeMap[c.trim()]={type:'DEV',nom:m.apellidos+' '+m.nombres,date:m.fecha}});
            });
        }

        function openModalLote() { document.getElementById('modalLote').style.display='flex'; updatePreview(); }
        function closeModalLote() { document.getElementById('modalLote').style.display='none'; }
        function updatePreview() {
            const ini = parseInt(document.getElementById('loteIni').value) || 0;
            const fin = parseInt(document.getElementById('loteFin').value) || 0;
            const ceros = parseInt(document.getElementById('loteCeros').value);
            document.getElementById('codePreview').innerText = ini.toString().padStart(ceros, '0');
            if(fin >= ini) document.getElementById('countPreview').innerText = `Se crearán: ${(fin - ini) + 1} códigos`;
            else document.getElementById('countPreview').innerText = "Rango inválido";
        }
        function generarLote() {
            const ini=document.getElementById('loteIni').value, f=document.getElementById('loteFin').value, c=document.getElementById('loteCeros').value;
            if(!ini||!f||parseInt(f)<parseInt(ini)){Swal.fire('Error','Rango','warning');return;}
            closeModalLote(); load(true);
            fetch(URL_API,{method:'POST',body:JSON.stringify({action:'generar_lote',inicio:ini,fin:f,ceros:c})}).then(r=>r.json()).then(res=>{ load(false); if(res.status==='success'){Swal.fire('Éxito',res.message,'success');recargarTodo();}else Swal.fire('Error',res.message,'error'); });
        }

        // RENDER TABLA DETALLADA
        function renderMov(l) {
            const tb=document.getElementById('tbody-mov'); tb.innerHTML='';
            l.forEach(f=>{
                const sig=f.firma?`<div class="sig-preview"><img src="${f.firma}"></div>`:'<span class="text-slate-300 italic text-[10px]">Pendiente</span>';
                
                tb.innerHTML+=`<tr>
                    <td class="text-[10px] font-mono font-bold text-slate-500">${f.fecha.replace(' ','<br>')}</td>
                    <td>
                        <div class="font-bold text-xs uppercase text-slate-800">${f.apellidos} ${f.nombres}</div>
                        <div class="text-[10px] font-bold text-blue-600 mt-1">${f.ci}</div>
                        <div class="text-[9px] text-slate-400 uppercase tracking-wide">${f.institucion}</div>
                    </td>
                    <td>
                        <div class="text-[10px] font-bold text-slate-500 mb-1">CANT: ${f.devueltos}</div>
                        <div class="code-box text-slate-400">${String(f.cod_dev).replace(/'/g,'')}</div>
                    </td>
                    <td>
                        <div class="text-[10px] font-bold text-rose-700 mb-1">CANT: ${f.recogidos}</div>
                        <div class="code-box text-rose-800 border-rose-200 bg-rose-50">${String(f.cod_rec).replace(/'/g,'')}</div>
                    </td>
                    <td class="p-1">${sig}</td>
                    <td class="text-[10px] italic text-slate-500">${f.observacion||'-'}</td>
                    <td>
                        <div class="action-flex">
                            <button onclick='editar(${JSON.stringify(f)})' class="btn-act act-edit" title="Editar"><i class="fa-solid fa-pen"></i></button>
                            <button onclick='imprimir(${JSON.stringify(f)})' class="btn-act act-print" title="Certificado PDF"><i class="fa-solid fa-print"></i></button>
                            <button onclick='borrarMov(${f.fila})' class="btn-act act-del" title="Borrar"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </td>
                </tr>`;
            });
        }

        function renderInv(l) {
            const tb=document.getElementById('tbody-inv'); tb.innerHTML='';
            l.forEach(i=>{
                const c=String(i.codigo).replace(/'/g,''); const info=codeMap[c]; let st,det,ac;
                if(i.estado==='DISPONIBLE'){ st='<span class="bg-emerald-50 text-emerald-700 border border-emerald-200 px-2 py-0.5 rounded text-[10px] font-bold">DISPONIBLE</span>'; det='<span class="text-xs text-slate-400 flex items-center gap-2"><i class="fa-solid fa-layer-group"></i> Ingreso por Lote</span>'; ac=`<button onclick="borrarInv(${i.fila})" class="btn-act act-del ml-auto"><i class="fa-solid fa-trash"></i></button>`; }
                else if(i.estado==='ENTREGADO'){ st='<span class="bg-rose-50 text-rose-700 border border-rose-200 px-2 py-0.5 rounded text-[10px] font-bold">ENTREGADO</span>'; det=info?`<div class="flex flex-col text-[10px] border-l-2 border-rose-500 pl-2"><span class="font-bold text-slate-700 uppercase">${info.nom}</span><span class="text-slate-400">${info.ci} • ${info.date.split(' ')[0]}</span></div>`:'<span class="text-rose-300 text-xs">Sin datos cruzados</span>'; ac=`<button onclick="baja(${i.fila})" class="text-[9px] border px-2 py-1 rounded hover:bg-slate-800 hover:text-white font-bold">BAJA</button>`; }
                else { st='<span class="bg-slate-100 text-slate-600 border border-slate-200 px-2 py-0.5 rounded text-[10px] font-bold">DEVUELTO</span>'; det=info?`<div class="flex flex-col text-[10px] border-l-2 border-slate-500 pl-2"><span class="font-bold text-slate-500 uppercase">Devuelto por: ${info.nom}</span><span class="text-slate-400">${info.date.split(' ')[0]}</span></div>`:'<span class="text-slate-400 text-xs">Baja Manual</span>'; ac='<i class="fa-solid fa-lock text-slate-200 text-xs"></i>'; }
                tb.innerHTML+=`<tr><td class="font-bold font-mono text-xs text-slate-700">${c}</td><td>${st}</td><td>${det}</td><td class="text-right">${ac}</td></tr>`;
            });
        }

        // GENERADOR PDF
        function imprimir(f) {
            const s=(i,v)=>{document.getElementById(i).innerText=v||'---';}; 
            s('pdf-ctrl', Math.floor(Math.random()*90000)+10000); 
            s('pdf-fecha', f.fecha.split(' ')[0]); 
            s('pdf-nombre', (f.apellidos+' '+f.nombres).toUpperCase()); 
            s('pdf-ci', String(f.ci).replace(/'/g,'')); 
            s('pdf-inst', (f.institucion||'').toUpperCase()); 
            s('pdf-dev-cant', f.devueltos||'0'); 
            s('pdf-dev-cod', String(f.cod_dev).replace(/'/g,'')||'---'); 
            s('pdf-rec-cant', f.recogidos||'0'); 
            s('pdf-rec-cod', String(f.cod_rec).replace(/'/g,'')||'---'); 
            s('pdf-obs', (f.observacion||'').toUpperCase()); 
            s('pdf-sign-ci', String(f.ci).replace(/'/g,'')); 
            
            const img=document.getElementById('pdf-sign-img'); 
            if(f.firma && f.firma.length>20){img.src=f.firma;img.style.display='block';}else{img.style.display='none';}
            
            const el = document.getElementById('pdf-template'); el.style.display='block'; 
            html2pdf().set({margin:10, filename:`ACTA_${f.ci}.pdf`, image:{type:'jpeg',quality:0.98}, html2canvas:{scale:2,useCORS:true}, jsPDF:{unit:'mm',format:'letter'}}).from(el).toPdf().get('pdf').then(pdf=>{ 
                document.getElementById('pdfFrame').src=pdf.output('bloburl'); 
                document.getElementById('btnDownload').onclick=()=>pdf.save(`ACTA_${f.ci}.pdf`); 
                document.getElementById('pdfModal').style.display='flex'; 
                el.style.display='none'; 
            });
        }

        function filtrarYPaginar() {
            const q=document.getElementById('globalSearch').value.toLowerCase();
            let base = currTab==='mov'?dMov:dInv.filter(i=>i.estado===invFilter);
            const dS=document.getElementById('dateStart').value; const dE=document.getElementById('dateEnd').value;
            if(currTab==='mov' && (dS||dE)){ base=base.filter(i=>{ if(!i.fecha)return false; const parts=i.fecha.split(' ')[0].split('/'); const dt=new Date(parts[2],parts[1]-1,parts[0]); const s=dS?new Date(dS+'T00:00:00'):null; const e=dE?new Date(dE+'T23:59:59'):null; return (!s||dt>=s)&&(!e||dt<=e); }); }
            if(currTab==='mov') fData=base.filter(i=>i.nombres.toLowerCase().includes(q)||i.apellidos.toLowerCase().includes(q)||String(i.ci).includes(q));
            else fData=base.filter(i=>String(i.codigo).includes(q));
            renderPagination();
        }
        function renderPagination() { const tot=fData.length; const sl=fData.slice((page-1)*rowsPerPage, page*rowsPerPage); document.getElementById('pag-info').innerText=`${tot>0?(page-1)*rowsPerPage+1:0}-${Math.min(page*rowsPerPage,tot)} de ${tot}`; if(currTab==='mov')renderMov(sl); else renderInv(sl); }
        function cambiarPagina(d){ page+=d; renderPagination(); }
        function switchTab(t){ currTab=t; page=1; document.getElementById('tab-mov').className=t==='mov'?'nav-btn active':'nav-btn'; document.getElementById('tab-inv').className=t==='inv'?'nav-btn active':'nav-btn'; document.getElementById('table-mov').classList.add('hidden'); document.getElementById('table-inv').classList.add('hidden'); document.getElementById('table-'+t).classList.remove('hidden'); const c=document.getElementById('inv-controls'); if(t==='inv')c.classList.remove('hidden'); else c.classList.add('hidden'); filtrarYPaginar(); }
        function setInvFilter(f){ invFilter=f; page=1; filtrarYPaginar(); }
        function load(s){document.getElementById('loader').style.display=s?'flex':'none';}
        function recargarTodo(){cargarTodo();}
        function updateStats() { const tot=dInv.length, dp=dInv.filter(i=>i.estado==='DISPONIBLE').length, et=dInv.filter(i=>i.estado==='ENTREGADO').length, dv=dInv.filter(i=>i.estado==='DEVUELTO').length; document.getElementById('stat-tot').innerText=dMov.length; document.getElementById('stat-disp').innerText=dp; document.getElementById('stat-ent').innerText=et; document.getElementById('stat-dev').innerText=dv; if(myChart)myChart.destroy(); const ctx=document.getElementById('chartMini').getContext('2d'); myChart=new Chart(ctx,{type:'doughnut',data:{labels:['Disp','Ent','Dev'],datasets:[{data:[dp,et,dv],backgroundColor:['#10b981','#f43f5e','#64748b'],borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,cutout:'70%',plugins:{legend:{display:false}}}}); }
        function generarReporteVisual(){ if(fData.length===0){Swal.fire('Vacio','','warning');return;} const w=window.open('','_blank'); let h=''; fData.forEach(f=>{ h+=`<tr><td style="padding:5px;border:1px solid #ccc;">${f.fecha.split(' ')[0]}</td><td style="padding:5px;border:1px solid #ccc;"><b>${f.apellidos} ${f.nombres}</b><br><small>${f.ci}</small></td><td style="padding:5px;border:1px solid #ccc;">${f.institucion}</td><td style="padding:5px;border:1px solid #ccc;"><b>${f.devueltos}</b><br><small>${f.cod_dev}</small></td><td style="padding:5px;border:1px solid #ccc;"><b>${f.recogidos}</b><br><small>${f.cod_rec}</small></td><td style="padding:5px;border:1px solid #ccc;">${f.observacion||''}</td><td style="padding:5px;border:1px solid #ccc;text-align:center;">${f.firma?`<img src="${f.firma}" height="40">`:''}</td></tr>`; }); w.document.write(`<html><body><h2>REPORTE ENTREGA/DEVOLUCION CEMEUD</h2><table style="width:100%;border-collapse:collapse;"><thead><tr><th>FECHA</th><th>FUNCIONARIO</th><th>INSTITUCION</th><th>DEV</th><th>ENT</th><th>OBS</th><th>FIRMA</th></tr></thead><tbody>${h}</tbody></table><script>window.print()<\/script></body></html>`); w.document.close(); }
        
        function baja(f){ Swal.fire({title:'¿Dar Baja?',showCancelButton:true,confirmButtonColor:'#d33'}).then(r=>{if(r.isConfirmed){load(true);fetch(URL_API,{method:'POST',body:JSON.stringify({action:'dar_baja',fila:f})}).then(()=>{load(false);recargarTodo();})}})}
        function borrarInv(f){ Swal.fire({title:'¿Borrar Item?',icon:'warning',showCancelButton:true,confirmButtonColor:'#d33'}).then(r=>{if(r.isConfirmed){load(true);fetch(URL_API,{method:'POST',body:JSON.stringify({action:'borrar_inventario',fila:f})}).then(()=>{load(false);recargarTodo();})}})}
        function borrarMov(f){ Swal.fire({title:'¿Borrar Registro?',text:'Se perderá el historial.',icon:'warning',showCancelButton:true,confirmButtonColor:'#d33'}).then(r=>{if(r.isConfirmed){load(true);fetch(URL_API,{method:'POST',body:JSON.stringify({action:'borrar',fila:f})}).then(()=>{load(false);recargarTodo();})}})}
        function guardarEdicion(){ const d={action:'editar', fila:document.getElementById('edFila').value, ci:document.getElementById('edCi').value, institucion:document.getElementById('edInst').value, nombres:document.getElementById('edNom').value, apellidos:document.getElementById('edApe').value, devueltos:document.getElementById('edDevCant').value, cod_dev:document.getElementById('edDevCod').value, recogidos:document.getElementById('edRecCant').value, cod_rec:document.getElementById('edRecCod').value, observacion:document.getElementById('edObs').value}; document.getElementById('modalEdit').style.display='none'; load(true); fetch(URL_API,{method:'POST',body:JSON.stringify(d)}).then(r=>r.json()).then(()=>{load(false);cargarTodo();Swal.fire('Guardado','','success');}); }
        function editar(f){ document.getElementById('edFila').value=f.fila; document.getElementById('edCi').value=String(f.ci).replace(/'/g,''); document.getElementById('edInst').value=f.institucion; document.getElementById('edNom').value=f.nombres; document.getElementById('edApe').value=f.apellidos; document.getElementById('edDevCant').value=f.devueltos; document.getElementById('edDevCod').value=String(f.cod_dev).replace(/'/g,''); document.getElementById('edRecCant').value=f.recogidos; document.getElementById('edRecCod').value=String(f.cod_rec).replace(/'/g,''); document.getElementById('edObs').value=f.observacion; document.getElementById('modalEdit').style.display='flex'; }
    </script>
</body>
</html>