<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEMEUD | Gestión Integral V19</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; color: #0f172a; font-size: 0.85rem; }
        #secure-content { display: none; height: 100vh; flex-direction: column; opacity: 0; transition: opacity 0.4s ease; }
        
        /* HEADER PREMIUM */
        .header-bg { background: #ffffff; border-bottom: 1px solid #e2e8f0; box-shadow: 0 4px 20px -10px rgba(0,0,0,0.05); }
        
        /* BOTONES NAV PRINCIPAL */
        .nav-btn { 
            padding: 8px 16px; border-radius: 8px; font-weight: 600; font-size: 0.8rem; 
            transition: all 0.2s; display: flex; align-items: center; gap: 8px; color: #64748b; 
        }
        .nav-btn:hover { background: #f8fafc; color: #0f172a; }
        .nav-btn.active { background: #eff6ff; color: #1e40af; border: 1px solid #bfdbfe; }

        /* SUB-MENU INVENTARIO (DINAMICO) */
        .sub-nav { display: flex; background: #f1f5f9; padding: 4px; border-radius: 8px; gap: 4px; }
        .sub-btn {
            flex: 1; text-align: center; padding: 6px 12px; border-radius: 6px; 
            font-size: 0.7rem; font-weight: 700; color: #64748b; transition: all 0.2s;
            border: 1px solid transparent; display: flex; justify-content: center; gap: 6px; align-items: center;
        }
        .sub-btn:hover { background: #e2e8f0; }
        .sub-btn.active-disp { background: #ffffff; color: #059669; border-color: #d1fae5; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .sub-btn.active-ent { background: #ffffff; color: #e11d48; border-color: #fecdd3; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .sub-btn.active-dev { background: #ffffff; color: #475569; border-color: #cbd5e1; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        
        .badge-count { background: rgba(0,0,0,0.05); padding: 1px 6px; border-radius: 10px; font-size: 0.65rem; }

        /* TABLA */
        .table-container { background: white; border-radius: 12px; border: 1px solid #e2e8f0; overflow: hidden; display: flex; flex-direction: column; flex: 1; }
        .thead-modern th { background: #f8fafc; color: #475569; padding: 12px 14px; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; border-bottom: 2px solid #e2e8f0; position: sticky; top: 0; z-index: 10; text-align: left; letter-spacing: 0.03em; }
        .tbody-modern td { padding: 10px 14px; vertical-align: top; border-bottom: 1px solid #f1f5f9; transition: background 0.1s; }
        .tbody-modern tr:hover td { background-color: #f8fafc; }

        /* COMPONENTES */
        .code-pill { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 5px; margin-top: 4px; width: 100%; }
        .code-text { font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: #334155; max-height: 50px; overflow-y: auto; word-break: break-all; line-height: 1.4; font-weight: 500; }
        
        .sig-container { height: 60px; display: flex; align-items: center; justify-content: center; background: #fff; border: 1px dashed #cbd5e1; border-radius: 6px; padding: 2px; }
        .sig-img { max-height: 100%; max-width: 100%; transition: transform 0.2s ease; cursor: zoom-in; }
        .sig-img:hover { transform: scale(4); background: white; border: 2px solid #be123c; border-radius: 6px; box-shadow: 0 10px 30px rgba(0,0,0,0.25); z-index: 50; padding: 5px; }

        /* ESTADOS INVENTARIO DETALLE */
        .detail-card { font-size: 0.75rem; padding: 6px 10px; border-radius: 6px; margin-top: 2px; display: flex; flex-direction: column; gap: 2px; border-left: 3px solid; }
        .det-disp { background: #ecfdf5; border-color: #10b981; color: #047857; }
        .det-ent { background: #fff1f2; border-color: #f43f5e; color: #9f1239; }
        .det-dev { background: #f1f5f9; border-color: #64748b; color: #475569; }

        /* MODALES */
        #pdfModal { opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        #pdfModal.active { opacity: 1; pointer-events: auto; }
        #pdf-template { display: none; }
        
        /* PDF INTERNO */
        .pdf-box { font-family: 'Times New Roman', serif; border: 3px double #000; padding: 25px; height: 100%; }
        .pdf-table { width: 100%; border-collapse: collapse; font-size: 11px; margin-bottom: 10px; table-layout: fixed; }
        .pdf-table th { background: #eee; border: 1px solid #000; padding: 5px; }
        .pdf-table td { border: 1px solid #000; padding: 6px; vertical-align: top; }
        .safe-text { word-wrap: break-word; white-space: pre-wrap; font-family: 'Courier New', monospace; font-size: 11px; font-weight: bold; }
        
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body>

    <div id="secure-content">
        <header class="header-bg h-16 flex-none px-6 flex items-center justify-between z-40 relative">
            <div class="flex items-center gap-6">
                <div class="flex items-center gap-3">
                    <div class="w-9 h-9 rounded-lg bg-slate-900 text-white flex items-center justify-center text-lg shadow-lg">
                        <i class="fa-solid fa-shield-cat"></i>
                    </div>
                    <div><h1 class="font-bold text-lg text-slate-900 leading-tight">CEMEUD</h1><p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Panel de Control</p></div>
                </div>
                
                <div class="flex bg-slate-100 p-1 rounded-lg gap-1">
                    <button onclick="switchTab('mov')" id="tab-mov" class="nav-btn active"><i class="fa-solid fa-list-check"></i> Registros</button>
                    <button onclick="switchTab('inv')" id="tab-inv" class="nav-btn"><i class="fa-solid fa-warehouse"></i> Inventario</button>
                </div>
            </div>

            <div class="flex items-center gap-3">
                <div class="flex items-center gap-2 bg-white border border-slate-200 p-1.5 rounded-lg shadow-sm">
                    <span class="text-[10px] font-bold text-slate-400 px-2 uppercase">Filtrar:</span>
                    <input type="date" id="dateStart" class="text-xs font-bold text-slate-700 outline-none w-24" onchange="filtrarYPaginar()">
                    <span class="text-slate-300">-</span>
                    <input type="date" id="dateEnd" class="text-xs font-bold text-slate-700 outline-none w-24" onchange="filtrarYPaginar()">
                    <button onclick="limpiarFechas()" class="text-slate-400 hover:text-red-500 px-2 transition"><i class="fa-solid fa-times"></i></button>
                </div>

                <button onclick="recargarTodo()" class="w-9 h-9 rounded-lg border border-slate-200 text-slate-500 hover:bg-slate-50 hover:text-blue-600 transition flex items-center justify-center shadow-sm" title="Actualizar"><i class="fa-solid fa-rotate"></i></button>
                <button onclick="generarReporteVisual()" class="bg-rose-700 text-white px-4 py-2 rounded-lg text-xs font-bold shadow-lg hover:bg-rose-800 transition flex items-center gap-2"><i class="fa-solid fa-print"></i> Reporte</button>
                <button onclick="cerrarSesion()" class="w-9 h-9 rounded-lg bg-red-50 text-red-600 hover:bg-red-100 transition flex items-center justify-center border border-red-100" title="Salir"><i class="fa-solid fa-power-off"></i></button>
            </div>
        </header>

        <main class="flex-1 overflow-hidden p-6 flex flex-col gap-6">
            
            <div id="stats-panel" class="grid grid-cols-4 gap-6 flex-none h-28">
                <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm flex items-center justify-between">
                    <div><p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Total Movimientos</p><h3 class="text-3xl font-black text-slate-800" id="stat-tot">0</h3></div>
                    <div class="p-3 bg-slate-50 rounded-xl text-slate-400"><i class="fa-solid fa-server text-xl"></i></div>
                </div>
                <div class="bg-white p-2 rounded-2xl border border-slate-200 shadow-sm flex col-span-1 relative overflow-hidden">
                     <canvas id="chartMini" class="w-full h-full"></canvas>
                </div>
                <div class="col-span-2 grid grid-cols-3 gap-3">
                    <div class="bg-emerald-50 p-3 rounded-xl border border-emerald-100 flex flex-col items-center justify-center"><span class="text-[10px] font-bold text-emerald-700 uppercase">Disponibles</span><div class="text-2xl font-black text-emerald-600" id="stat-disp">0</div></div>
                    <div class="bg-rose-50 p-3 rounded-xl border border-rose-100 flex flex-col items-center justify-center"><span class="text-[10px] font-bold text-rose-700 uppercase">Entregados</span><div class="text-2xl font-black text-rose-600" id="stat-ent">0</div></div>
                    <div class="bg-slate-100 p-3 rounded-xl border border-slate-200 flex flex-col items-center justify-center"><span class="text-[10px] font-bold text-slate-500 uppercase">Devueltos</span><div class="text-2xl font-black text-slate-600" id="stat-dev">0</div></div>
                </div>
            </div>

            <div class="table-container">
                <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-white z-20">
                    <div class="relative w-80 group">
                        <i class="fa-solid fa-search absolute left-3 top-3 text-slate-400 group-focus-within:text-blue-600 transition"></i>
                        <input id="globalSearch" onkeyup="filtrarYPaginar()" type="text" class="w-full pl-10 pr-4 py-2.5 border border-slate-200 rounded-xl text-xs font-bold text-slate-700 bg-slate-50 focus:bg-white focus:ring-2 focus:ring-blue-100 focus:border-blue-500 outline-none transition" placeholder="Buscar Funcionario, CI, Código...">
                    </div>
                    
                    <div id="inv-controls" class="hidden flex gap-4 items-center">
                        <div class="sub-nav">
                            <button onclick="setInvFilter('DISPONIBLE')" id="btn-disp" class="sub-btn">Disponible <span class="badge-count" id="badge-disp">0</span></button>
                            <button onclick="setInvFilter('ENTREGADO')" id="btn-ent" class="sub-btn">Entregado <span class="badge-count" id="badge-ent">0</span></button>
                            <button onclick="setInvFilter('DEVUELTO')" id="btn-dev" class="sub-btn">Devuelto <span class="badge-count" id="badge-dev">0</span></button>
                        </div>
                        <button onclick="document.getElementById('modalLote').classList.remove('hidden')" class="bg-slate-900 text-white px-4 py-2 rounded-lg text-xs font-bold shadow hover:bg-black transition flex items-center gap-2"><i class="fa-solid fa-plus"></i> Lote</button>
                    </div>
                </div>

                <div class="flex-1 overflow-auto custom-scroll relative bg-white">
                    <table id="table-mov" class="w-full border-collapse">
                        <thead class="thead-modern">
                            <tr>
                                <th style="width: 100px;">FECHA</th>
                                <th style="width: 25%;">DATOS DEL FUNCIONARIO</th>
                                <th style="width: 20%;">DEVOLUCIÓN (BAJA)</th>
                                <th style="width: 20%;">ENTREGA (NUEVO)</th>
                                <th style="width: 100px; text-align:center;">FIRMA</th>
                                <th style="width: 15%;">OBSERVACIONES</th>
                                <th style="width: 80px; text-align:right;">ACCIÓN</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-mov" class="tbody-modern text-slate-600"></tbody>
                    </table>
                    <table id="table-inv" class="w-full border-collapse hidden">
                        <thead class="thead-modern">
                            <tr>
                                <th style="width: 160px;">CÓDIGO ÚNICO</th>
                                <th style="width: 120px;">ESTADO</th>
                                <th>HISTORIAL Y TRAZABILIDAD (DETALLE)</th>
                                <th style="width: 80px; text-align:right;">GESTIÓN</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-inv" class="tbody-modern text-slate-600"></tbody>
                    </table>
                </div>

                <div class="p-3 border-t border-slate-100 bg-slate-50 flex justify-between items-center text-[11px] font-bold text-slate-500">
                    <span id="pag-info" class="bg-white px-3 py-1 rounded border border-slate-200 shadow-sm">Cargando...</span>
                    <div class="flex gap-2">
                        <button onclick="cambiarPagina(-1)" id="btn-prev" class="px-4 py-1.5 bg-white border border-slate-200 rounded-lg hover:bg-slate-100 disabled:opacity-50 transition shadow-sm">Anterior</button>
                        <button onclick="cambiarPagina(1)" id="btn-next" class="px-4 py-1.5 bg-white border border-slate-200 rounded-lg hover:bg-slate-100 disabled:opacity-50 transition shadow-sm">Siguiente</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="modalEdit" class="fixed inset-0 bg-slate-900/60 z-50 hidden flex items-center justify-center backdrop-blur-sm"><div class="bg-white rounded-2xl shadow-2xl w-[650px] flex flex-col max-h-[90vh]"><div class="bg-slate-900 text-white p-4 font-bold flex justify-between rounded-t-2xl text-sm items-center"><span>EDITAR REGISTRO</span><button onclick="document.getElementById('modalEdit').classList.add('hidden')" class="text-white hover:text-slate-300">✕</button></div><div class="p-6 overflow-y-auto custom-scroll space-y-4 text-xs"><input type="hidden" id="edFila"><div class="grid grid-cols-2 gap-4"><div><label class="font-bold text-slate-400 block mb-1">CI</label><input id="edCi" class="w-full border p-2.5 rounded-lg font-bold bg-slate-50"></div><div><label class="font-bold text-slate-400 block mb-1">INSTITUCIÓN</label><input id="edInst" class="w-full border p-2.5 rounded-lg uppercase"></div><div><label class="font-bold text-slate-400 block mb-1">NOMBRES</label><input id="edNom" class="w-full border p-2.5 rounded-lg uppercase"></div><div><label class="font-bold text-slate-400 block mb-1">APELLIDOS</label><input id="edApe" class="w-full border p-2.5 rounded-lg uppercase"></div></div><div class="grid grid-cols-2 gap-4 pt-4 border-t border-slate-100"><div class="bg-slate-50 p-4 rounded-xl border border-slate-200"><label class="font-bold text-center block mb-2 text-slate-500">DEVOLUCIÓN</label><input id="edDevCant" class="w-full border p-2 rounded text-center font-bold mb-2 bg-white"><textarea id="edDevCod" class="w-full border p-2 h-20 font-mono text-xs bg-white rounded"></textarea></div><div class="bg-rose-50 p-4 rounded-xl border border-rose-100"><label class="font-bold text-center block mb-2 text-rose-700">ENTREGA</label><input id="edRecCant" class="w-full border p-2 rounded text-center font-bold mb-2 bg-white text-rose-700 border-rose-200"><textarea id="edRecCod" class="w-full border p-2 h-20 font-mono text-xs bg-white rounded border-rose-200"></textarea></div></div><div><label class="font-bold text-slate-400 block mb-1">OBSERVACIONES</label><textarea id="edObs" class="w-full border p-3 rounded-lg h-16 text-slate-600 bg-slate-50"></textarea></div></div><div class="p-4 border-t flex justify-end gap-3 bg-slate-50 rounded-b-2xl"><button onclick="document.getElementById('modalEdit').classList.add('hidden')" class="px-5 py-2 border border-slate-300 rounded-lg font-bold text-xs bg-white text-slate-600 hover:bg-slate-100">Cancelar</button><button onclick="guardarEdicion()" class="bg-slate-900 text-white px-5 py-2 rounded-lg font-bold text-xs shadow hover:bg-black transition">GUARDAR CAMBIOS</button></div></div></div>
    <div id="modalLote" class="fixed inset-0 bg-slate-900/60 z-50 hidden flex items-center justify-center backdrop-blur-sm"><div class="bg-white rounded-2xl p-6 w-80 shadow-2xl"><h3 class="font-bold text-lg mb-4 text-slate-800">Nuevo Lote</h3><input id="loteIni" type="number" class="w-full border-2 border-slate-200 p-2.5 rounded-xl mb-3 text-center text-lg font-bold outline-none focus:border-rose-500" placeholder="Inicio"><input id="loteFin" type="number" class="w-full border-2 border-slate-200 p-2.5 rounded-xl mb-3 text-center text-lg font-bold outline-none focus:border-rose-500" placeholder="Fin"><select id="loteCeros" class="w-full border-2 border-slate-200 p-2.5 rounded-xl mb-5 text-sm font-bold text-slate-600"><option value="5">5 Dígitos</option><option value="6">6 Dígitos</option></select><div class="flex gap-2"><button onclick="document.getElementById('modalLote').classList.add('hidden')" class="w-1/2 border py-2.5 rounded-xl font-bold text-xs text-slate-500 hover:bg-slate-50">Cancelar</button><button onclick="generarLote()" class="w-1/2 bg-blue-600 text-white py-2.5 rounded-xl font-bold text-xs hover:bg-blue-700 shadow-lg">Generar</button></div></div></div>
    <div id="pdfModal" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/90 backdrop-blur-sm p-4 hidden"><div class="bg-white w-full max-w-4xl h-[90vh] rounded-xl shadow-2xl flex flex-col overflow-hidden"><div class="bg-slate-900 text-white p-3 flex justify-between items-center shadow-md"><div class="font-bold text-sm flex items-center gap-2"><i class="fa-solid fa-file-pdf text-rose-400"></i> Vista Previa</div><div class="flex gap-2"><button onclick="document.getElementById('pdfModal').classList.add('hidden')" class="px-4 py-1.5 rounded-lg text-xs font-bold text-slate-300 hover:bg-white/10 transition">Cerrar</button><button id="btnDownload" class="bg-white text-slate-900 hover:bg-slate-100 px-4 py-1.5 rounded-lg text-xs font-bold shadow flex items-center gap-2 transition"><i class="fa-solid fa-download"></i> Descargar</button></div></div><div class="flex-1 bg-slate-200 relative"><iframe id="pdfFrame" class="w-full h-full border-none"></iframe></div></div></div>
    <div id="loader" class="fixed inset-0 bg-white/90 hidden flex flex-col items-center justify-center z-50"><div class="w-12 h-12 border-4 border-slate-200 border-t-rose-600 rounded-full animate-spin"></div><span class="text-xs font-bold mt-4 text-slate-400 tracking-widest uppercase">Cargando...</span></div>

    <div id="pdf-template" style="display:none;width:750px;padding:20px;box-sizing:border-box;">
        <div class="pdf-box">
            <div class="pdf-header"><div style="width:60px;text-align:center;font-size:35px;font-weight:bold;border:2px solid #000;border-radius:50%;height:50px;line-height:45px;margin-right:15px;">S</div><div style="flex-grow:1;text-align:center;"><div style="font-size:12px;font-weight:bold;">ESTADO PLURINACIONAL DE BOLIVIA</div><div style="font-size:10px;font-weight:bold;">UNIDAD DE ESTADÍSTICAS DE SALUD (CEMEUD)</div><div style="font-size:14px;font-weight:bold;text-decoration:underline;margin-top:5px;">ACTA DE ENTREGA DE VALORES</div></div><div style="text-align:right;font-size:10px;border:1px solid #000;padding:5px;"><b>ID:</b> <span id="pdf-ctrl"></span><br><b>FECHA:</b> <span id="pdf-fecha"></span></div></div>
            <div style="font-size:11px;font-weight:bold;background:#eee;border:1px solid #000;border-bottom:none;padding:3px;">I. DATOS DEL FUNCIONARIO</div>
            <table class="pdf-table"><tr><td width="70%"><b>NOMBRE:</b> <span id="pdf-nombre"></span></td><td><b>CI:</b> <span id="pdf-ci"></span></td></tr><tr><td colspan="2"><b>INSTITUCIÓN:</b> <span id="pdf-inst"></span></td></tr></table>
            <div style="font-size:11px;font-weight:bold;background:#eee;border:1px solid #000;border-bottom:none;padding:3px;margin-top:10px;">II. DETALLE DE VALORES</div>
            <table class="pdf-table"><tr><th width="50%">DEVOLUCIÓN (BAJA)</th><th width="50%">ENTREGA (NUEVO)</th></tr><tr><td><b>CANT:</b> <span id="pdf-dev-cant" style="font-size:13px;"></span><br><div class="safe-text" id="pdf-dev-cod"></div></td><td><b>CANT:</b> <span id="pdf-rec-cant" style="font-size:13px;"></span><br><div class="safe-text" id="pdf-rec-cod"></div></td></tr></table>
            <div style="border:1px solid #000;padding:5px;font-size:10px;margin-top:5px;"><b>OBS:</b> <span id="pdf-obs"></span></div>
            <div style="margin-top:40px;display:flex;justify-content:space-around;text-align:center;"><div style="width:40%;"><div style="height:70px;display:flex;align-items:end;justify-content:center;margin-bottom:-10px;"><img id="pdf-sign-img" style="max-height:70px;max-width:100%;display:none;"></div><div style="border-top:1px solid #000;font-size:10px;font-weight:bold;padding-top:3px;">FIRMA FUNCIONARIO</div><div style="font-size:9px;">CI: <span id="pdf-sign-ci"></span></div></div><div style="width:40%;margin-top:60px;"><div style="border-top:1px solid #000;font-size:10px;font-weight:bold;padding-top:3px;">RESPONSABLE CEMEUD</div></div></div>
        </div>
    </div>

    <script>
        const URL_API = "https://script.google.com/macros/s/AKfycbxJoLudHYzMH_Tn5tBMDPFHQ153SRDkvK9Wu4lDRPLMoGX7McDIkS-Gon2_tQoEq09F/exec"; 
        
        document.addEventListener('DOMContentLoaded', iniciarSesion);
        function iniciarSesion() { Swal.fire({ title: 'ACCESO SEGURO', html: '<input id="u" class="swal2-input" placeholder="Usuario"><input id="p" type="password" class="swal2-input" placeholder="Contraseña">', showCancelButton:false, confirmButtonText:'ENTRAR', confirmButtonColor:'#0f172a', preConfirm:()=>{const u=document.getElementById('u').value,p=document.getElementById('p').value;if(u==='SUISD'&&p==='SUISD')return true;Swal.showValidationMessage('Error');} }).then(r=>{if(r.isConfirmed){document.getElementById('secure-content').style.display='flex';setTimeout(()=>document.getElementById('secure-content').style.opacity='1',50);cargarTodo();}}); }
        function cerrarSesion() { location.reload(); }

        let dMov=[], dInv=[], fData=[], currTab='mov', invFilter='DISPONIBLE', codeMap={}, page=1; const rowsPerPage=10;
        let myChart = null;

        function cargarTodo() { load(true); Promise.all([fetch(URL_API,{method:'POST',body:JSON.stringify({action:'leer_registros'})}).then(r=>r.json()), fetch(URL_API,{method:'POST',body:JSON.stringify({action:'leer_inventario'})}).then(r=>r.json())]).then(([rMov,rInv])=>{ load(false); if(rMov.status==='success') dMov=rMov.data; if(rInv.status==='success') dInv=rInv.data; buildMap(); updateStats(); filtrarYPaginar(); }).catch(()=>{load(false);}); }

        // MAPEO DE TRAZABILIDAD (Histórico de Devolución)
        function buildMap() {
            codeMap = {};
            dMov.forEach(m => {
                const recs = String(m.cod_rec).split(/[\n,]+/).map(c=>c.trim().replace(/'/g,''));
                recs.forEach(c => { if(c) codeMap[c] = { type: 'ENT', nom: `${m.apellidos} ${m.nombres}`, ci: String(m.ci).replace(/'/g,''), date: m.fecha }; });
                const devs = String(m.cod_dev).split(/[\n,]+/).map(c=>c.trim().replace(/'/g,''));
                devs.forEach(c => { if(c) codeMap[c] = { type: 'DEV', nom: `${m.apellidos} ${m.nombres}`, ci: String(m.ci).replace(/'/g,''), date: m.fecha }; });
            });
        }

        function limpiarFechas() { document.getElementById('dateStart').value=''; document.getElementById('dateEnd').value=''; filtrarYPaginar(); }
        function switchTab(t){ currTab=t; page=1; 
            document.getElementById('tab-mov').className = t==='mov'?'nav-btn active':'nav-btn';
            document.getElementById('tab-inv').className = t==='inv'?'nav-btn active':'nav-btn';
            document.getElementById('table-mov').classList.add('hidden'); document.getElementById('table-inv').classList.add('hidden'); document.getElementById('table-'+t).classList.remove('hidden'); 
            const c=document.getElementById('inv-controls'); if(t==='inv')c.classList.remove('hidden'); else c.classList.add('hidden'); 
            filtrarYPaginar(); 
        }
        
        function setInvFilter(f){ 
            invFilter=f; page=1; 
            ['disp','ent','dev'].forEach(k => document.getElementById('btn-'+k).className = 'sub-btn');
            if(f==='DISPONIBLE') document.getElementById('btn-disp').className='sub-btn active-disp';
            if(f==='ENTREGADO') document.getElementById('btn-ent').className='sub-btn active-ent';
            if(f==='DEVUELTO') document.getElementById('btn-dev').className='sub-btn active-dev';
            filtrarYPaginar(); 
        }

        function filtrarYPaginar() {
            const q=document.getElementById('globalSearch').value.toLowerCase(), s=document.getElementById('dateStart').value, e=document.getElementById('dateEnd').value;
            let base = currTab==='mov'?dMov:dInv.filter(i=>i.estado===invFilter);
            if(currTab==='mov' && (s||e)){ base=base.filter(i=>{ const [d,m,y]=i.fecha.split(' ')[0].split('/'); const dt=new Date(`${y}-${m}-${d}`); return (!s||dt>=new Date(s))&&(!e||dt<=new Date(e)); }); }
            if(currTab==='mov') fData=base.filter(i=>i.nombres.toLowerCase().includes(q)||i.apellidos.toLowerCase().includes(q)||String(i.ci).includes(q)||String(i.cod_rec).includes(q));
            else fData=base.filter(i=>String(i.codigo).includes(q));
            renderPagination();
        }
        function renderPagination() { const tot=fData.length, max=Math.ceil(tot/rowsPerPage)||1; if(page>max)page=max; if(page<1)page=1; const sl=fData.slice((page-1)*rowsPerPage, page*rowsPerPage); document.getElementById('pag-info').innerText=`${tot>0?(page-1)*rowsPerPage+1:0}-${Math.min(page*rowsPerPage,tot)} de ${tot}`; document.getElementById('btn-prev').disabled=page===1; document.getElementById('btn-next').disabled=page===max; if(currTab==='mov')renderMov(sl); else renderInv(sl); }
        function cambiarPagina(d){ page+=d; renderPagination(); }

        // RENDER MOVIMIENTOS
        function renderMov(l) {
            const tb=document.getElementById('tbody-mov'); tb.innerHTML='';
            l.forEach(f=>{
                const tr=document.createElement('tr'); const ci=String(f.ci).replace(/'/g,'');
                const firma = f.firma ? `<div class="sig-container"><img src="${f.firma}" class="sig-img"></div>` : '<span class="text-[10px] text-slate-300 italic">Pendiente</span>';
                tr.innerHTML=`
                <td class="font-mono text-[10px] font-bold text-slate-500">${f.fecha.replace(' ','<br>')}</td>
                <td><div class="font-bold text-xs uppercase text-slate-800">${f.apellidos} ${f.nombres}</div><div class="text-[10px] text-slate-500 font-bold mt-0.5"><span class="bg-slate-100 px-1 rounded border">${ci}</span> ${f.institucion}</div></td>
                <td><div class="flex items-start gap-2"><div class="font-bold text-slate-400 text-xs w-6 pt-1">${f.devueltos}</div><div class="code-pill"><div class="code-text">${String(f.cod_dev).replace(/'/g,'')}</div></div></div></td>
                <td><div class="flex items-start gap-2"><div class="font-bold text-rose-600 text-xs w-6 pt-1">${f.recogidos}</div><div class="code-pill border-rose-100"><div class="code-text text-slate-800 font-bold">${String(f.cod_rec).replace(/'/g,'')}</div></div></div></td>
                <td class="align-middle p-2">${firma}</td>
                <td class="text-[10px] text-slate-500 italic leading-tight">${f.observacion||'-'}</td>
                <td class="text-right"><div class="flex justify-end gap-1"><button onclick='editar(${JSON.stringify(f)})' class="w-7 h-7 rounded border border-slate-200 flex items-center justify-center hover:bg-slate-100 text-slate-600"><i class="fa-solid fa-pen"></i></button><button onclick='imprimir(${JSON.stringify(f)})' class="w-7 h-7 rounded border border-blue-200 flex items-center justify-center hover:bg-blue-50 text-blue-600"><i class="fa-solid fa-print"></i></button><button onclick='borrarMov(${f.fila})' class="w-7 h-7 rounded border border-red-200 flex items-center justify-center hover:bg-red-50 text-red-600"><i class="fa-solid fa-trash"></i></button></div></td>`;
                tb.appendChild(tr);
            });
        }

        // RENDER INVENTARIO (INTELIGENTE)
        function renderInv(l) {
            const tb=document.getElementById('tbody-inv'); tb.innerHTML='';
            l.forEach(i=>{
                const c=String(i.codigo).replace(/'/g,''); const info = codeMap[c];
                let st='', det='', ac='';

                if (i.estado === 'DISPONIBLE') {
                    st = '<span class="badge-status st-disp text-[10px] font-bold px-2 py-0.5 rounded border border-emerald-200 text-emerald-700 bg-emerald-50">DISPONIBLE</span>';
                    det = '<div class="detail-card det-disp"><i class="fa-solid fa-warehouse mr-1"></i> En Almacén Central</div>';
                    ac = `<button onclick="borrarInv(${i.fila})" class="w-6 h-6 rounded flex items-center justify-center hover:bg-red-50 text-red-400 ml-auto"><i class="fa-solid fa-trash"></i></button>`;
                } else if (i.estado === 'ENTREGADO') {
                    st = '<span class="badge-status st-ent text-[10px] font-bold px-2 py-0.5 rounded border border-rose-200 text-rose-700 bg-rose-50">ENTREGADO</span>';
                    if (info) det = `<div class="detail-card det-ent"><div><b>En custodia:</b> ${info.nom}</div><div class="opacity-75 font-mono text-[10px]">${info.ci} • ${info.date}</div></div>`;
                    else det = '<span class="text-rose-300 text-[10px]">Sin datos cruzados</span>';
                    ac = `<button onclick="baja(${i.fila},'${c}')" class="text-[10px] border border-slate-200 px-2 py-1 rounded hover:bg-slate-800 hover:text-white transition font-bold">DAR BAJA</button>`;
                } else { // DEVUELTO
                    st = '<span class="badge-status st-dev text-[10px] font-bold px-2 py-0.5 rounded border border-slate-200 text-slate-600 bg-slate-50">DEVUELTO</span>';
                    // DETALLE DE QUIÉN DEVOLVIÓ
                    if (info && info.type === 'DEV') det = `<div class="detail-card det-dev"><div><b>Devuelto por:</b> ${info.nom}</div><div class="opacity-75 font-mono text-[10px]"><i class="fa-solid fa-calendar-check mr-1"></i>${info.date}</div></div>`;
                    else det = '<span class="text-slate-300 text-[10px] italic">Baja Manual / Histórico</span>';
                    ac = `<i class="fa-solid fa-lock text-slate-200"></i>`;
                }
                tb.innerHTML+=`<tr><td class="font-bold font-mono text-xs text-slate-700">${c}</td><td>${st}</td><td>${det}</td><td class="text-right">${ac}</td></tr>`;
            });
        }

        // STATS & GRÁFICOS
        function updateStats() {
            const tot=dInv.length, dp=dInv.filter(i=>i.estado==='DISPONIBLE').length, et=dInv.filter(i=>i.estado==='ENTREGADO').length, dv=dInv.filter(i=>i.estado==='DEVUELTO').length;
            document.getElementById('stat-tot').innerText=dMov.length; document.getElementById('stat-disp').innerText=dp; document.getElementById('stat-ent').innerText=et; document.getElementById('stat-dev').innerText=dv;
            
            document.getElementById('badge-disp').innerText = dp;
            document.getElementById('badge-ent').innerText = et;
            document.getElementById('badge-dev').innerText = dv;

            if (myChart) myChart.destroy();
            const ctx = document.getElementById('chartMini').getContext('2d');
            myChart = new Chart(ctx, { type: 'doughnut', data: { labels: ['Disp', 'Ent', 'Dev'], datasets: [{ data: [dp, et, dv], backgroundColor: ['#10b981', '#f43f5e', '#64748b'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { display: false } } } });
        }

        // IMPRESIÓN CERTIFICADO
        function imprimir(f) {
            const s=(i,v)=>{document.getElementById(i).innerText=v||'---';};
            s('pdf-ctrl', Math.floor(Math.random()*90000)+10000); s('pdf-fecha', f.fecha.split(' ')[0]);
            s('pdf-nombre', (f.apellidos+' '+f.nombres).toUpperCase()); s('pdf-ci', String(f.ci).replace(/'/g,'')); s('pdf-inst', (f.institucion||'').toUpperCase());
            s('pdf-dev-cant', f.devueltos||'0'); s('pdf-dev-cod', String(f.cod_dev).replace(/'/g,'')||'---');
            s('pdf-rec-cant', f.recogidos||'0'); s('pdf-rec-cod', String(f.cod_rec).replace(/'/g,'')||'---');
            s('pdf-obs', (f.observacion||'').toUpperCase()); s('pdf-sign-ci', String(f.ci).replace(/'/g,''));
            const img=document.getElementById('pdf-sign-img'); if(f.firma && f.firma.length>20){img.src=f.firma;img.style.display='block';}else{img.style.display='none';}
            const el=document.getElementById('pdf-template'); el.style.display='block';
            html2pdf().set({margin:10, filename:`ACTA_${String(f.ci).replace(/'/g,'')}.pdf`, image:{type:'jpeg',quality:0.98}, html2canvas:{scale:2,useCORS:true}, jsPDF:{unit:'mm',format:'letter'}}).from(el).toPdf().get('pdf').then(pdf=>{ document.getElementById('pdfFrame').src=pdf.output('bloburl'); document.getElementById('btnDownload').onclick=()=>pdf.save(`ACTA_FIRMADA.pdf`); document.getElementById('pdfModal').classList.remove('hidden'); setTimeout(()=>document.getElementById('pdfModal').classList.add('active'),50); el.style.display='none'; });
        }

        // REPORTE VISUAL (CON CANTIDADES Y FIRMA GRANDE)
        function generarReporteVisual() {
            if(fData.length===0){Swal.fire('Sin Datos','','warning');return;} const win=window.open('','_blank'); let rows='';
            fData.forEach(f=>{
                const fImg=f.firma?`<img src="${f.firma}" style="height:55px;display:block;margin:0 auto;">`:'';
                rows+=`<tr style="border-bottom:1px solid #ccc;">
                    <td style="padding:10px;white-space:nowrap;">${f.fecha.split(' ')[0]}</td>
                    <td style="padding:10px;"><b>${f.apellidos} ${f.nombres}</b><br><small>${String(f.ci).replace(/'/g,'')}</small></td>
                    <td style="padding:10px;">${f.institucion}</td>
                    <td style="padding:10px;vertical-align:top;"><b>CANT: ${f.devueltos}</b><br><div style="font-family:'Courier New';font-weight:bold;font-size:11px;">${String(f.cod_dev).replace(/'/g,'')}</div></td>
                    <td style="padding:10px;vertical-align:top;"><b>CANT: ${f.recogidos}</b><br><div style="font-family:'Courier New';font-weight:bold;font-size:11px;">${String(f.cod_rec).replace(/'/g,'')}</div></td>
                    <td style="padding:10px;font-size:10px;">${f.observacion||''}</td>
                    <td style="padding:5px;text-align:center;">${fImg}</td>
                </tr>`;
            });
            win.document.write(`<html><head><title>REPORTE CEMEUD</title><style>@page{size:landscape;margin:10mm;}body{font-family:Arial,sans-serif;font-size:11px;}table{width:100%;border-collapse:collapse;}th{background:#eee;border:1px solid #000;padding:8px;text-align:left;}td{border:1px solid #999;vertical-align:top;}tr{page-break-inside:avoid;}</style></head><body><h2 style="text-align:center;">REPORTE DE MOVIMIENTOS DETALLADO</h2><div style="text-align:center;margin-bottom:15px;">Generado: ${new Date().toLocaleString()}</div><table><thead><tr><th width="8%">FECHA</th><th width="15%">FUNCIONARIO</th><th width="12%">INST.</th><th width="20%">DEVOLUCIÓN</th><th width="20%">ENTREGA</th><th width="10%">OBS</th><th width="15%">FIRMA</th></tr></thead><tbody>${rows}</tbody></table><script>window.print();<\/script></body></html>`); win.document.close();
        }

        // CRUD
        function load(s){document.getElementById('loader').className=s?"fixed inset-0 bg-white/90 flex flex-col items-center justify-center z-50":"hidden";}
        function recargarTodo(){cargarTodo();}
        function generarLote(){ const i=document.getElementById('loteIni').value, f=document.getElementById('loteFin').value, c=document.getElementById('loteCeros').value; document.getElementById('modalLote').classList.add('hidden'); load(true); fetch(URL_API, {method:'POST', body:JSON.stringify({action:'generar_lote', inicio:i, fin:f, ceros:c})}).then(r=>r.json()).then(res=>{ load(false); Swal.fire('Éxito',res.message,'success'); recargarTodo(); }); }
        function baja(f,c) { Swal.fire({title:'¿Baja?', showCancelButton:true}).then(r=>{ if(r.isConfirmed){ load(true); fetch(URL_API,{method:'POST',body:JSON.stringify({action:'dar_baja',fila:f})}).then(()=>{load(false);recargarTodo();}); } }); }
        function borrarInv(f) { Swal.fire({title:'¿Borrar?', icon:'warning', showCancelButton:true, confirmButtonColor:'#d33'}).then(r=>{ if(r.isConfirmed){ load(true); fetch(URL_API,{method:'POST',body:JSON.stringify({action:'borrar_inventario',fila:f})}).then(()=>{load(false);recargarTodo();}); } }); }
        function borrarMov(f) { Swal.fire({title:'¿Borrar?', text:'Se eliminará el historial', icon:'warning', showCancelButton:true, confirmButtonColor:'#d33'}).then(r=>{ if(r.isConfirmed){ load(true); fetch(URL_API,{method:'POST',body:JSON.stringify({action:'borrar',fila:f})}).then(()=>{load(false);recargarTodo();}); } }); }
        function editar(f) { document.getElementById('edFila').value=f.fila; document.getElementById('edCi').value=String(f.ci).replace(/'/g,''); document.getElementById('edInst').value=f.institucion; document.getElementById('edNom').value=f.nombres; document.getElementById('edApe').value=f.apellidos; document.getElementById('edDevCant').value=f.devueltos; document.getElementById('edDevCod').value=String(f.cod_dev).replace(/'/g,''); document.getElementById('edRecCant').value=f.recogidos; document.getElementById('edRecCod').value=String(f.cod_rec).replace(/'/g,''); document.getElementById('edObs').value=f.observacion; document.getElementById('modalEdit').classList.remove('hidden'); }
        function guardarEdicion() { const d={action:'editar', fila:document.getElementById('edFila').value, ci:document.getElementById('edCi').value, institucion:document.getElementById('edInst').value, nombres:document.getElementById('edNom').value, apellidos:document.getElementById('edApe').value, devueltos:document.getElementById('edDevCant').value, cod_dev:document.getElementById('edDevCod').value, recogidos:document.getElementById('edRecCant').value, cod_rec:document.getElementById('edRecCod').value, observacion:document.getElementById('edObs').value}; document.getElementById('modalEdit').classList.add('hidden'); load(true); fetch(URL_API,{method:'POST',body:JSON.stringify(d)}).then(r=>r.json()).then(()=>{load(false);cargarTodo();Swal.fire('Guardado','','success');}); }
        function exportarExcel(){ if(dMov.length===0)return; const ws=XLSX.utils.json_to_sheet(dMov.map(d=>({Fecha:d.fecha,CI:d.ci,Nombre:d.nombres+' '+d.apellidos,Inst:d.institucion,Dev:d.devueltos,Rec:d.recogidos,Obs:d.observacion}))); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Reporte"); XLSX.writeFile(wb,"Reporte_CEMEUD.xlsx"); }
    </script>
</body>
</html>